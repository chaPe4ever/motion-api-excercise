# GitHub Actions Setup Guide for Motion API

This guide explains how to configure GitHub Actions and secrets for automated deployment of the Motion API project.

## Prerequisites

- GitHub repository for motion-api project
- DigitalOcean droplet (or similar server) with SSH access
- Domain name pointing to your server's IP address
- Docker installed on your server

## One-Time Server Setup (Required)

Before the first deployment (or if you see **"sudo: a terminal is required"** or "Host nginx setup failed"), run this **one-time step on your server** so the deploy can set up nginx and SSL without a password:

1. **Server sudoers for SSL (required for HTTPS)**  
   SSH into the server, then:
   ```bash
   sudo visudo
   ```
   Add **exactly one** of these lines (use the path that matches your `PROJECT_DIR` secret). The `*` at the end allows the script to receive arguments (required for CI):
   ```
   runner ALL=(ALL) NOPASSWD: /bin/bash /home/runner/motion-api/scripts/setup-host-nginx-auto.sh *
   ```
   If your project lives elsewhere (e.g. `/home/runner/app`), use that path instead:
   ```
   runner ALL=(ALL) NOPASSWD: /bin/bash /home/runner/app/scripts/setup-host-nginx-auto.sh *
   ```
   Replace `runner` with your actual `SERVER_USER` if different. Save and exit. After the next deploy, host nginx will run with sudo (no TTY), certs will be copied to the host, and HTTPS will work.

2. If collectstatic already failed once, fix volume permissions:
   ```bash
   cd $PROJECT_DIR
   docker compose -f docker-compose.prod.yml run --rm -u root backend chown -R 1000:1000 /app/staticfiles
   ```

## Step 1: Configure GitHub Secrets

Go to your GitHub repository → **Settings** → **Secrets and variables** → **Actions** → **New repository secret**

Add the following secrets:

### Server Configuration

| Secret Name | Description | Example |
|------------|-------------|---------|
| `SERVER_USER` | SSH username for your server | `runner` or `ubuntu` |
| `SERVER_HOST` | Server IP address or hostname | `165.227.158.61` |
| `PROJECT_DIR` | Directory on server where project will be deployed | `/home/runner/app/motion-api` |

**Note**: Use a different `PROJECT_DIR` than plannr if deploying both projects on the same server.

### Application Configuration

| Secret Name | Description | How to Generate |
|------------|-------------|-----------------|
| `SECRET_KEY` | Django secret key (must be unique and secret) | `python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"` |
| `ALLOWED_HOSTS` | Domain name(s) for your application | `api.motion.example.com` or `api.motion.example.com www.api.motion.example.com` |

**Important**: Use a different domain than plannr (e.g., `api.motion.example.com` vs `plannr.example.com`).

### Database Configuration

| Secret Name | Description | Example |
|------------|-------------|---------|
| `POSTGRES_DB` | PostgreSQL database name | `motion_api_db` |
| `POSTGRES_USER` | PostgreSQL username | `motion_api_user` |
| `POSTGRES_PASSWORD` | PostgreSQL password (strong password) | Generate a strong password |

**Note**: Use different database credentials than plannr if sharing the same PostgreSQL server.

### Docker Image Configuration

**Note**: This is automatically generated by the workflow, but you can override if needed.

| Secret Name | Description | Default |
|------------|-------------|---------|
| `BACKEND_IMAGE` | Backend Docker image (auto-generated) | `ghcr.io/your-username/motion-api/backend:latest` |

## Step 2: Configure SSH Access

### Option A: Using SSH Key (Recommended)

1. **Generate SSH key pair** (if you don't have one):
   ```bash
   ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/id_ed25519_github
   ```

2. **Copy public key to server**:
   ```bash
   ssh-copy-id -i ~/.ssh/id_ed25519_github.pub SERVER_USER@SERVER_HOST
   ```

3. **Add private key to GitHub Secrets**:
   - Go to repository → Settings → Secrets → Actions
   - Create secret: `SSH_PRIVATE_KEY`
   - Value: Contents of `~/.ssh/id_ed25519_github` (private key)

4. **Update GitHub Actions workflow** (if needed):
   - The workflow should use the SSH key for authentication
   - Make sure `SERVER_USER` and `SERVER_HOST` secrets are set

### Option B: Using Password (Less Secure)

If using password authentication, add:
- Secret: `SERVER_PASSWORD` (your server password)

**Note**: SSH key authentication is strongly recommended for security.

## Step 3: Verify Repository Settings

1. **Enable GitHub Actions**:
   - Go to repository → Settings → Actions → General
   - Ensure "Allow all actions and reusable workflows" is enabled

2. **Check workflow permissions**:
   - Go to repository → Settings → Actions → General
   - Under "Workflow permissions", ensure "Read and write permissions" is selected
   - Check "Allow GitHub Actions to create and approve pull requests"

## Step 4: First Deployment

1. **Push to main/master branch**:
   ```bash
   git push origin main
   ```

2. **Monitor deployment**:
   - Go to repository → Actions tab
   - Watch the workflow run
   - Check for any errors

3. **Verify deployment**:
   - SSH into your server
   - Check containers: `docker ps`
   - Check logs: `docker compose -f docker-compose.prod.yml logs`
   - Visit your domain: `https://api.motion.example.com`

## Step 5: SSL Certificate Setup

SSL certificates are **automatically obtained** during the first deployment if:
- Domain DNS points to your server
- Port 80 is accessible from the internet
- Certbot can verify domain ownership

If automatic SSL setup fails:
1. Check DNS: `dig api.motion.example.com`
2. Check firewall: Ensure port 80 is open
3. Wait for DNS propagation (5-10 minutes)
4. Manually run certbot on server:
   ```bash
   sudo certbot --nginx -d api.motion.example.com
   ```

## Multi-Domain Setup (Same Server)

If deploying both **plannr** and **motion-api** on the same server:

### Port Configuration

- **Plannr**: Uses port `8080` (nginx container)
- **Motion API**: Uses port `8001` (backend directly)
- **Host Nginx**: Listens on ports `80` and `443`

### Database Configuration

You can either:
1. **Use separate databases** (recommended):
   - Plannr: `POSTGRES_DB=plannr_db`
   - Motion API: `POSTGRES_DB=motion_api_db`

2. **Share same PostgreSQL server**:
   - Use different database names
   - Use different ports if needed (plannr: 5432, motion-api: 5433)

### Project Directories

Use different `PROJECT_DIR` for each project:
- Plannr: `/home/runner/app/plannr`
- Motion API: `/home/runner/app/motion-api`

## Troubleshooting

### Deployment Fails

1. **Check GitHub Actions logs**:
   - Go to repository → Actions → Click on failed workflow
   - Review error messages

2. **Common issues**:
   - **Host key verification failed**: The workflow adds the server to `known_hosts` via `ssh-keyscan`. Ensure the "Set up SSH" and "Add server to known hosts" steps run before any `ssh`/`scp` commands. If you still see this, confirm `SSH_PRIVATE_KEY` is set and contains the full private key (including `-----BEGIN ... KEY-----` and `-----END ... KEY-----`).
   - Missing secrets: Verify all required secrets are set (including `SSH_PRIVATE_KEY`)
   - SSH connection failed: Check `SERVER_USER`, `SERVER_HOST`, and that the public key is in the server's `~/.ssh/authorized_keys`
   - Docker login failed: Check `GITHUB_TOKEN` (automatically provided)
   - Build failed: Check Dockerfile and build logs

### SSL Certificate Issues

1. **Certificates not obtained**:
   - Verify domain DNS points to server IP
   - Check port 80 is accessible: `curl -I http://api.motion.example.com`
   - Check certbot logs: `docker compose logs certbot`

2. **Certificates not copied to host**:
   - Check Docker volume exists: `docker volume ls | grep certbot`
   - Verify setup script ran: Check deployment logs
   - Manually copy certificates if needed

### Container Issues

1. **Containers not starting**:
   - Check logs: `docker compose -f docker-compose.prod.yml logs`
   - Verify environment variables: `docker compose config`
   - Check database connection: `docker compose exec backend python manage.py dbshell`

2. **Port conflicts**:
   - Verify port 8001 is available: `lsof -i :8001`
   - Check host nginx is running: `sudo systemctl status nginx`
   - Verify no conflicts with plannr (port 8080)

### Database Connection Issues

1. **Connection refused**:
   - Check PostgreSQL container is running: `docker ps | grep postgres`
   - Verify database credentials match
   - Check port mapping (5433 for motion-api)

2. **Migration errors**:
   - Check database exists: `docker compose exec db psql -U $POSTGRES_USER -l`
   - Run migrations manually: `docker compose exec backend python manage.py migrate`

## Security Best Practices

1. **Use strong passwords** for database and secrets
2. **Rotate secrets regularly** (especially `SECRET_KEY`)
3. **Use SSH keys** instead of passwords
4. **Limit server access** to necessary IPs
5. **Keep Docker images updated** (workflow uses `:latest` tag)
6. **Monitor GitHub Actions** for unauthorized access
7. **Use different domains** for each project
8. **Isolate databases** (use different database names)

## Required Secrets Summary

**Minimum required secrets**:
- `SSH_PRIVATE_KEY` (private key for SSH access to server)
- `SERVER_USER`
- `SERVER_HOST`
- `PROJECT_DIR`
- `SECRET_KEY`
- `ALLOWED_HOSTS`
- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`

**Optional secrets** (add as needed):
- None currently (motion-api is backend-only)

## Deployment Flow

1. **Push to main/master** → Triggers GitHub Actions workflow
2. **Build backend image** → Builds Docker image from Dockerfile
3. **Push to registry** → Pushes to GitHub Container Registry
4. **Copy files to server** → Copies docker-compose.yml, scripts, nginx templates
5. **Run deploy script** → 
   - Checks for SSL certificates
   - Obtains/renews certificates if needed
   - Sets up host nginx
   - Starts containers
   - Runs migrations
   - Collects static files

## Next Steps

After setting up GitHub Actions:
1. Push to main/master to trigger deployment
2. Monitor first deployment in Actions tab
3. Verify application is accessible at your domain
4. Test API endpoints
5. Set up monitoring and backups
6. Configure domain DNS if not already done

## API Endpoints

After deployment, your API will be available at:
- `https://api.motion.example.com/health/` - Health check
- `https://api.motion.example.com/api/` - API endpoints
- `https://api.motion.example.com/api/docs/` - Swagger documentation
